### 语法制导
- 将文法符号和某些属性相关联，并通过语义规则来**描述如何计算属性的值**
- 如 $E\to E_{1}+T$ 属性 code 代表表达式的逆波兰表示 $E.code = E1.code || T.code || '+'$ ，||表示字符串（逆波兰表达式）的拼接
- 语法制导翻译就是在产生式体中加入语义动作，**在适当时候执行动作**$E\to E_{1}+T \ \ \{print'+'\}$

- 语法制导 SDD 是上下文无关文法和属性、规则的结合
	- 属性和文法符号关联，确定各个文法符号需要哪些属性，对于节点 X 的属性 a，表示为 X.a
	- 规则和产生式相关联

- 语义规则确定了节点上属性的取值和计算
	- 假设使用 type 表示类型，place 表示属性
	- ![image.png|450](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240327103329.png)
	- ![image.png|450](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240327103342.png)

- 综合属性
	- 节点 N 的属性值由 N 的**产生式**所关联的语义规则来定义
	- 即通过**子节点**或 N 本身的属性值来定义
	- 允许依赖于 N 本身的**继承属性**
- 继承属性
	- 结点 N 的属性值由 N 的父结点所关联的语义规则来定义
	- 依赖于 **N 的父结点、N 本身和 N 的兄弟结点**上的属性值（不允许通过子节点来定义）
- 终结符号只有综合属性，没有继承属性：**终结符号**的属性值是**由词法分析器提供的词法值**，SDD 中没有计算终结符号的属性值的语义规则
- ![image.png|525](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240327104217.png)

### SDD
- 只包含**综合属性**的 SDD 称为 **S 属性 SDD**
	- 每个语义规则都根据**产生式体**子节点中的属性值来计算头部非终结符号的属性值
	- S 属性的 SDD 可以和 LR 语法分析器一起实现，通过栈中的属性获取信息

- 语义规则不应该有复杂的副作用，要求副作用不影响其他属性求值。没有副作用的 SDD 称为**属性文法**
	- 每个语义规则仅仅通过它的输入属性（继承属性和综合属性）计算出其输出属性的值，而**不依赖于外部状态**，也不改变外部状态。
- 一个因为改变了全局变量造成了副作用的例子：
```kotlin
Expr -> Expr + Term  {Expr.val = Expr.val + Term.val; count++;}
Expr -> Term         {Expr.val = Term.val;}
Term -> 0            {Term.val = 0; count++;}
Term -> 1            {Term.val = 1; count++;}
```

#### 注释语法分析树
- 注释语法分析树：包含了各个**节点各属性值**的语法分析树
	- 对于任意的输入串，首**先**构造出相应的**分析树** 
	- 给各个结点 (根据其文法符号) **加上相应的属性** 
	- 按照语义规则**计算**这些属性的值
- S 属性的 SDD（只含综合属性） 一定可以通过**自底向上**的方式求值
- ![image.png|475](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240327105312.png)

- SDD 无法计算循环定义的语法 $A\to B \ \ \ A.s=B.i \ \ \ B.i=A.s+1$

- 适用于**自顶向下分析**的 SSD
	- 对于自顶向下分析需要先去除左递归，但是这又可能破坏结构
	- 对于消除左递归后的式子 $T\to FT' \ \ \ T'\to*FT'|\varepsilon$ ($T\to T*F|F$)
	- ![image.png|475](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402112803.png)
	- T 对应的项中，第一个**因子对应 F**，而**运算符却在 T'** 中需要用**继承属性**来完成这样的计算
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402113050.png)
	- 即 ![image.png|475](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402114245.png)

#### SDD 的求值顺序
- 需要先求出 N 的属性所依赖的节点的属性，才能计算得到 N 的属性
- 使用**依赖图**来表示计算顺序：计算顺序组成偏序关系, 存在环则说明无解

- 依赖图描述了分析书上各个属性之间的信息流（计算顺序）
	- $a\to b$ 表示计算 $b$ 需要 $a$ 的值
	- 对于分析树结点 N，与 N 关联的**每个属性** a 都对应依赖图的**一个结点**N.a
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402120841.png)
- 各个属性值需要按照依赖图的**拓扑排序**的顺序进行计算
	- 给定一个 SDD，很难判定是否存在一棵分析树，其对应的依赖图包含环
	- SL 属性的 SDD 一定无无环，并且有固定的计算顺序
##### S 属性的 SDD
- 每个属性**都是综合属性**，都是根据子构造的属性来计算父构造的属性
- 可以与自底向上或自顶向下的语法分析过程**一起计算**
	- 自底向上：构造分析树节点同时计算相关的属性（此时子节点的属性已经计算完毕）
	- 自顶向下：后序思想，最后计算 A 的属性（此时其他过程已经完成）
		- ![image.png|475](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402135429.png)
##### L 属性的 SDD
- 每个属性是综合属性或继承属性（$A\to X_{a}\dots X_{n}$ 中 $X_{i}.a$ 的计算只用 A 的继承属性或 $X_{j}(j<i)$ 的继承属性或综合属性）
	- 即在一个产生式体所关联的各个属性之间**总是从左到右**，而不能是从右到左；总是使用来自**上/左**边的属性信息
	- 对于非终结符号 $A$，参数为继承属性，返回值为综合属性
	- ![image.png|450](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402140328.png)

- ![image.png|375](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402140259.png)

#### 具有受控副作用的语义规则
- 属性文法虽然没有副作用，但是**增加了描述的复杂度**
	- 比如标识符表就需要作为属性传递
	- 但是如果把标识符表作为全局变量，就可以简化这个过程
- **受控的副作用**
	- 不会对属性求值产生约束，仍然可以**按照任何拓扑顺序**求值而不影响结果
	- 也可能对求值的过程添加简单的约束

- 使用全局标识符表，通过 addType 将类型信息加入到标识符表
	- ![image.png|350](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402140939.png)
- $L → E n \{ print(E.val); \}$
	- 通过副作用打印出 E 的值（输出操作通常会改变程序的状态，因此认为是有副作用的）
	- 但是因为**总在最后执行**，**不影响**其它属性的求值
#### SDD 的应用
##### 抽象语法树的构造
- 抽象语法树**不包含**源代码中可能出现的**不影响程序语义**的元素，比如括号、特定的关键字等（删除了不影响程序意义的如括号分号等信息，忽略掉非本质的东西）
	- 每个节点代表一个语法结构，对应于**运算符**
	- 节点的子节点表示其子结构，对应于**运算分量**
- 每个节点用一个对象表示
	- 叶子节点中只存放**词法值**
	- 内部节点中存放了 **op 值和参数**

- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402141922.png)
- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402141929.png)
	- 对于生产式 3、4 没有产生任何新节点
- 使用**后序遍历**进行求值

- 一个自顶向下处理的 L 属性 SDD 的例子
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402143346.png)
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240402143405.png)

##### 类型结构
- 
### 语法制导的翻译方案 SDT

