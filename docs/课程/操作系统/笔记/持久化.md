### 文件管理 
- 数据项：文件系统中最低级数据组织形式：
	- 基本数据项：描述一个对象的某种属性的一个值（数据中最小逻辑单位）
	- 组合数据项：多个基本数据项祖晨
- 记录：相关数据项的集合，描述对象在某方面的属性
- 文件：具有文件名的一组相关元素的集合。
- 文件是以硬盘为载体存储在计算机上的信息集合
- 文件系统用于实现对文件的维护管理

- 文件控制块：操作系统通过**文件控制块 FCB**来维护文件元数据
	- FCB 的有序集合就是**文件目录**，一个 FCB 就是一个文件目录项（也可以被视为文件-目录文件）
	- 存储文件的基本信息（文件名、物理位置）；基本控制信息（存取权限）；使用信息（上次修改时间）
- 目录结构：由于检索时可能不需要 FCB 完整信息，可以将文件名与文件描述信息分离，将文件描述信息单独为索引节点，文件目录中的每个目录项进包括文件名和索引节点号（这样就减少了单个条目的大小）
#### 文件的基本操作
- 创建文件：为新文件分配外存空间；在目录中创建目录项
- 删除文件：根据文件名**查找**目录，删除对应的目录项和文件控制块然后回收文件占用的存储空间
- 读写文件：先根据文件名查找目录，找到指定文件的目录项后从中得到文件在外存中的地址，之后利用目录项中的指针进行读写操作
- 访问类型：读、写、执行（装入内存执行）、追加（append）、删除、列表清单（元数据）
- 访问控制
	- 根据用户身份进行控制，对用户进行分类：拥有者、组内其他成员、其他
	- 3（用户类型）\*4（读、写、删除、执行）位表示

- 打开文件：
	- 多次读写一个文件时总需要检索目录，为了减少重复操作，系统维护一个包含所有打开文件信息的表（打开文件表）
	- open 打开文件后将目录项从外存复制到内存的**打开文件表**，并向用户返回**文件描述符**
	- 用户再次打开时可以直接用**文件描述符**从打开文件表获取信息（即只有初次打开才使用文件名）
	-  close 后从打开文件表移除
- 多进程文件
	- 多个进程可以同时打开文件，使用两级表来表示：
		- **系统表**：包含**与进程无关的信息**，如文件在磁盘上的位置、大小等
		- **进程表**：进程对文件的使用信息，如**读写指针**等
	- 一个进程 open 时，在进程表中增加了一个条目，**指向系统表**的对应条目
	- 系统表会维护打开计数器，文件不再（计数器为 0）使用时自动从系统表删除
	- ![a2516ac49185dc6c9f19a90caec8187.jpg|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/a2516ac49185dc6c9f19a90caec8187.jpg)
#### 文件结构
##### 逻辑结构
- 无结构文件：由字符串流组成（流式文件），通过读写指针**以字节的形式进行访问**（只能穷举搜索），源程序、可执行文件等都是。
- 有结构文件：由一个以上的记录构成
	- 定长记录：文件中所有**记录长度都相同**，检索较快（随机访问）
	- 变长记录：长度不一定相同，只能顺序访问，较慢

- **顺序文件**
	- 文件中的记录按顺序排序，读写效率较高，但是查找、修改较慢
	- 串结构：记录之间的顺序取决于插入顺序，只能顺序查找
	- 顺序结构：按关键字排列，可以折半查找
- **索引文件**
	- 解决变长记录顺序文件不能随机访问的问题
	- **索引表**包含指向记录的指针和记录长度，索引表本身是一个定长记录的顺序文件
- **索引顺序文件**
	- 每个索引指向的项为一组记录，通过索引找到组之后再顺序查找
	- 最佳划分 $\sqrt{ n }$ 个索引，每个组 $\sqrt{ n }$ 个条目，平均查找次数 $\sqrt{ n }$
	- 即分块查找
- **直接文件/散列文件**
##### 物理结构
- **连续分配**
	- 每个文件在磁盘上占用连续的块
	- 支持顺序访问、直接访问
	- 速度较快，磁头移动距离少
	- 产生外部碎片，无法满足动态增长需求，不适合对文件进行增删

- **链接分配**
	- 消除了外部碎片，提高利用率
	- 便于动态增长即管理
	- **隐式分配**
		- 用链表来表示，每个盘块有指向下一个盘块的指针
		- 问题：只支持顺序访问、存在稳定性问题（一个块损坏）
		- 可以按簇（多个连续块一组）进行分配，可以加速查找并且减少指针，但是会增加内部碎片
	- **显示链接**
		- 用链接表表示块之间的链接关系，即**文件分配表 FAT**
		- 每个表项存储盘块号和下一块的地址
		- 用-1 表示最后一块，-2 表示空闲
		- 支持顺序访问（FAT 不大，可以加入内存，处理很快）减少了磁盘访问次数
		- ![2a66e41ea779b3269d5d0196a65d940.jpg|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/2a66e41ea779b3269d5d0196a65d940.jpg)

- **索引分配**
	- **单级索引**
		- 将每个文件的盘块号放在一起，访问时调入内存，而不需要将整个 FAT 放在内存
		- 索引也作为一个块在磁盘上
		- 问题时索引块占用空间，文件很大时还需要很多索引块链接
		- ![|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/3369ea0ae4bad4c719863e376797a9d.jpg)
	- **多级索引**
		- 处理索引块太多时的问题
		- 问题：需要加载很多索引块，IO 开销较大
	- **混合索引**
		- 兼顾大中小文件，假设一个块 $4KB$
		- 对于小文件直接将每个盘块地址直接放入 FCB，直接寻址访问；比如设置 10 个直接地址（最多有 10 个块）即支持 $40KB$
		- 对于中型文件使用单级索引，在 FCB 指向索引表，一次间址 (一个索引块里 1024 个盘块)，即同时使用支持 $4MB+40KB$
		- 对于大文件使用多级索引，如同时使用到三级，就支持 $4TB+4GB+4MB+40KB$
		- ![63fa240764a1798b849315b41f073d8.jpg|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/63fa240764a1798b849315b41f073d8.jpg)

#### 目录
- FCB **作为文件目录项**
- 目录提供了文件名到文件的映射（按名存取）

- **单级目录**：线性目录表，通过遍历查找，并且不允许重名
- **两级目录**：分为主文件目录（记录用户名和相应的用户目录文件的位置）和用户目录（用户所有文件的 FCB）多用户之间可以存在同名文件。但是还不够灵活
- **树形目录**：提高目录的检索速度和文件系统的性能，通过**文件路径名**来访问文件，系统中每一个文件都有唯一的路径（大多操作系统现在都是使用树形目录）。为了避免反复查询，可以添加一个当前工作目录，使用相对路径进行访问（但是非初次访问还是使用文件描述符）
	- 层次结构清晰，便于分类管理，但是查询相对较慢，并且有较多磁盘 IO
- **无环图目录**：在树形目录的基础上加上一些**指向同一节点**的有向边，得到一个 DAG，可以更方便的共享目录、文件。
	- 在想要删除节点时同样可以使用访问计数来管理

- 文件共享：多个用户共享一个文件时，系统中只需保留该文件的一个副本
	- 硬链接：基于**索引节点**，两个用户的文件目录指向相同的共享文件的索引节点指针
		- ![|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514145200.png)
	- 软链接：利用符号链实现文件共享，创建一个 LINK 类型的新文件，指向要共享的文件（类似于快捷方式）操作系统遇到 LINK 文件后会重定位使用其中记录的路径去查询文件 F
		- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514145213.png)
		- 当文件所有者删除一个文件之后，其他用户通过 LINK 进行访问就会出错
- 目录的查询方式：线性法、查询法
#### 文件系统
- ![image.png|150](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514151717.png)

- 文件系统布局
	- 文件系统在磁盘中的结构：磁盘每个分区有一个独立的文件系统
		- **主引导记录 MBR**：位于磁盘 0 号扇区，MBR 包含主引导程序和分区表（给出每个分区的起始和结束地址），通过 MBR 来确认活动分区，并读入对应的引导块
		- **引导块**：MBR 执行引导块中的程序之后负责启动该分区中的操作系统
		- **超级块**：包含文件系统的所有关键信息，在计算机启动时加入内存，包含：分区快的数目、大小、空闲快、空闲 FCB 等
		- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514151743.png)
	- 文件系统在内存中的结构：用于管理文件系统并通过缓存来提高性能
		- 安装表：安装的文件系统的分区的相关信息
		- 目录结构和缓存：包含最近访问的目录信息
		- 整个系统代开文件表
		- 每个进程打开文件表记文件描述符（句柄）

- 外存空闲空间的管理
	- 一个磁盘可以进行分区（卷），每个分区包含目录区（）FCB和文件区；多个磁盘也可以通过 RAID 组成一个分区
	- 存储设备管理实际上就是对外存中的空闲块进行组织和管理
	- **空闲表法：**
		- 属于连续分配方式，类似于内存的动态分区分配，每个文件分配一段连续的存储空间
		- 每个空闲区对应一个空闲表项：包含序号、起始块号和数目
		- 分配上也可以使用首次、最佳适应等短发
		- 回收时同样考虑进行区间合并
		- 具有较高的分配速度
	- **空闲链表法：**
		- 把所有空闲盘区组织为一个空闲链
		- 空闲盘块链：一盘块为单位拉成一条链；用户请求时从开始位置选取一定数目空闲狂进行分配；释放时将盘块插入到末尾；效率较低（单位太小了）
		- 空闲盘区链：机爱你个空闲盘区拉成链（每个盘区包含若干相邻的盘块），类似于动态分区分配，效率相对较高但是比较复杂
	- **位示图法：**
		- 用二进制每一位表示磁盘中盘块的使用情况
		- 如 m 个 n 位数表示 $m\times n$ 个盘块的使用情况
	- **成组链接法：**
		- 更适用于大型文件系统
		- 将空闲盘块分组，如 100 个一组，每组第一个盘块记录下一组的数目和空闲盘块号，即由各组的第一块连接成一条链
		- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514154028.png)
		- 分配：移动指针进行分配，移动到栈底时切换到下一个分组继续分配
		- 回收：将回收的盘块号放入栈顶并移动指针，已满时创建新栈

- 虚拟文件系统
	- 屏蔽差异，为用户提供统一接口
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514154442.png)
- 文件系统挂载
	- 文件系统在使用之前需要先进行挂载
	- 挂载到目录之后就可以通过目录访问设备上的文件
	- 使用：超级快对象；索引节点对象；目录项对象；文件对象；
### IO
#### 设备无关软件
- 负责执行所有设备的公有操作
##### 高速缓冲
- 利用内存来暂存磁盘中的信息，逻辑上属于磁盘，物理上属于内存
- 缓冲区同时只支持单向数据流
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514170307.png)
- 单缓冲：每当用户发出一个 io 请求，就分配一个缓冲区（一个块）设备现将数据传送到缓冲区在传送到工作区
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514165815.png)
	- T 和 C 可以并行，处理每块数据的平均时间 $Max(C,T)+M$
- 双缓冲: 设备输入时可以交替使用两个缓冲区
	- ![image.png|500](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514170024.png)
	- T 与 C、M 都可以并行 $Max(T,C+M)$
- 循环缓冲：
	- 包含许多大小相等的缓冲区，in 指向第一个可以输入数据（缓存）的块；out 指向第一个可以提取数据（进行运算）的块
	- ![image.png|300](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240514170422.png)
- 缓冲池：管理多个缓冲区
	- 将缓冲区划分为：空缓冲队列；输入队列；输出队列
	- **收容输入**数据的工作缓冲区 hin：从空缓冲区队列取下缓冲区**作为收容输入**的工作缓冲区，装满数据后挂到输入队列的队尾
	- **提取输入**数据的工作缓冲区 sin：从输入队列队首取得缓冲区，作为提取输入工作缓冲区，使用数据后将缓冲区归还到空队列
	- **收容输出**数据的工作缓冲区 hout
	- **提取输出**数据的工作缓冲区 sout
##### 设备分配与回收
- 
